language: python
python:
  - '3.7'
os: linux
cache:
  directories:n
  - "$HOME/.local"
  - ".cache-loader"
jobs:
  include:
    - stage: tests
      name: "Jest Unit Tests"
      language: node_js
      node_js:
        - "12"
      install:
      - cd backend && npm install
      script:
      - npm run test
    - stage: build
      name: "Building Project"
      install:
      - pip install awscli
      - pip install aws-sam-cli
      - npm install
      script:
      - |
        if [ "$TRAVIS_BRANCH" == "master" ]; then
          npm run build
          echo "dashboard.sustainability.oregonstate.edu" >> dist/CNAME
        else
          npm run build-stage
        fi
        cd backend
        sam validate
        sam package --template-file template.yaml --s3-bucket osu-so-serverless-builds --output-template-file packaged.yaml
        cd ../
      deploy:
      - provider: script
        script: cd backend; sam deploy --template-file ./packaged.yaml --stack-name energy
          --capabilities CAPABILITY_IAM; cd ../;
        cleanup: false
        on:
          branch: master
      - provider: pages
        local_dir: dist/
        cleanup: false
        github_token: "$GITHUB_TOKEN"
        keep_history: true
        on:
          branch: master
      - provider: s3
        access_key_id: "$S3_ACCESS_ID"
        secret_access_key: "$S3_ACCESS_KEY"
        bucket: energy-dashboard
        cleanup: false
        region: "$AWS_DEFAULT_REGION"
        local_dir: dist
        on:
          all_branches: true
          condition: "$TRAVIS_BRANCH != master"
env:
  global:
  - AWS_DEFAULT_REGION=us-west-2