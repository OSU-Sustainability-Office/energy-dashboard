# @Author: Brogan Miner <Brogan>
# @Date:   2018-12-20T10:38:57-08:00
# @Email:  brogan.miner@oregonstate.edu
# @Last modified by:   Brogan
# @Last modified time: 2019-04-06T10:09:28-07:00

language: node_js
python:
- '2.7'
node_js:
- '10'
before_install:
- openssl aes-256-cbc -K $encrypted_3e7d443718a9_key -iv $encrypted_3e7d443718a9_iv
  -in .env.enc -out .env -d
- mv .env tests/.env
cache:
  directories:
  - "$HOME/.local"
  - ".cache-loader"
install:
  - pip install awscli
  - pip install aws-sam-cli
  - npm --prefix backend/dependencies/nodejs install
  - 'pip install plantuml --user'
script:
- |
  if [ "$TRAVIS_BRANCH" == "master" ]; then
    npm install
    npm run build
    echo "dashboard.sustainability.oregonstate.edu" >> dist/CNAME
  else
    npm install
    npm run build-stage
  fi
  cd backend
  sam validate
  sam package --template-file template.yaml --s3-bucket osu-so-serverless-builds --output-template-file packaged.yaml
  cd ../
#  python plantuml.py -tsvg $(find documents | grep .puml) 
#  mv $(find documents | grep .svg) dist/*


deploy:
- provider: script
  script: >-
    cd backend;
    sam deploy --template-file ./packaged.yaml --stack-name auth --capabilities CAPABILITY_IAM;
    cd ../;
  skip-cleanup: true
- provider: pages
  local-dir: dist/
  skip-cleanup: true
  github-token: "$GITHUB_TOKEN"
  keep-history: true
  on:
    branch: master
- provider: s3
  access_key_id: "$S3_ACCESS_ID"
  secret_access_key: "$S3_ACCESS_KEY"
  bucket: energy-dashboard
  skip_cleanup: true
  local_dir: dist
  on:
    all_branches: true
    condition: $TRAVIS_BRANCH != master
# after_deploy:
# - mocha tests/integration.js
